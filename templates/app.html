<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>80s Prom Mystery ‚Äî Player App</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body class="app {{ 'phase-two' if phase_two else 'phase-one' }}">
  <header class="topbar app-top">
    <div>
      <div class="title">ü™© 80s Prom Mystery</div>
      <div class="subtitle">Public Feed, DMs, and Suspect points</div>
    </div>
    {% if character %}
      <div class="user-chip">
        <div class="avatar small">{{ character.avatar_emoji }}</div>
        <div>
          <div class="user-name">{{ character.name }}</div>
          <div class="user-tag">Logged in</div>
        </div>
        <a class="link" href="{{ url_for('app_logout') }}">Switch</a>
      </div>
    {% endif %}
  </header>

  <main class="app-shell" data-active-tab="{{ tab or 'feed' }}">
    {% if error %}
      <div class="alert">{{ error }}</div>
    {% endif %}

    {% if not character %}
      <section class="panel">
        <div class="panel-title">Enter your code</div>
        <p class="muted">Ask the GM if you forgot yours.</p>
        <form class="login-form" action="{{ url_for('app_login') }}" method="post">
          <input type="text" name="code" placeholder="ALEX9" maxlength="6" required autofocus />
          <button class="btn primary" type="submit">Log In</button>
        </form>
      </section>
    {% endif %}

    <div class="tab-row">
      <button class="tab-btn {% if (tab or 'feed') == 'feed' %}active{% endif %}" data-tab="feed">Public</button>
      <button class="tab-btn {% if (tab or 'feed') == 'dm' %}active{% endif %}" data-tab="dm" {% if not character %}disabled{% endif %}>
        DMs
        <span class="dm-badge {% if dm_unread_total == 0 %}hidden{% endif %}" id="dm-badge" data-count="{{ dm_unread_total }}">{{ dm_unread_total }}</span>
      </button>
      <button class="tab-btn {% if (tab or 'feed') == 'suspect' %}active{% endif %} {% if not phase_two %}hidden-tab{% endif %}" id="suspect-tab" data-tab="suspect" data-locked="{{ 0 if phase_two else 1 }}" {% if not character %}disabled{% endif %}>
        Suspect
        <span class="tab-clock {% if cooldown_remaining == 0 %}hidden{% endif %}" id="suspect-clock">‚è±</span>
      </button>
      <button class="tab-btn {% if (tab or 'feed') == 'wallet' %}active{% endif %}" data-tab="wallet" {% if not character %}disabled{% endif %}>
        Wallet
        <span class="dm-badge {% if wallet_pending_count == 0 %}hidden{% endif %}" id="wallet-badge" data-count="{{ wallet_pending_count }}">{{ wallet_pending_count }}</span>
      </button>
      <button class="tab-btn {% if (tab or 'feed') == 'jukebox' %}active{% endif %}" data-tab="jukebox">
        DJ Requests
      </button>
    </div>

    <section class="panel tab-panel {% if (tab or 'feed') == 'feed' %}active{% endif %}" data-tab="feed">
      {% if character %}
        <div class="panel-title">Post to Public</div>
        <form class="post-form" action="{{ url_for('app_post') }}" method="post">
          <textarea name="content" rows="3" placeholder="Share a clue, alibi, or rumor‚Ä¶" maxlength="280" required></textarea>
          <div class="form-row">
            <label class="checkbox">
              <input type="checkbox" name="anonymous">
              <span>Post as Anonymous</span>
            </label>
            <div class="actions">
              <button class="btn" type="button" onclick="document.querySelector('.post-form textarea').value=''">Clear</button>
              <button class="btn primary" type="submit">Post Public</button>
            </div>
          </div>
        </form>
      {% else %}
        <p class="muted">Log in to post. Feed is read-only right now.</p>
      {% endif %}
      <div class="panel-head">
        <div>
          <div class="panel-title">Public Feed</div>
          <div class="panel-subtitle">Phones + TV see this together</div>
        </div>
        <div class="pill live">LIVE</div>
      </div>
      <div class="message-list" id="app-feed">
        {% for m in messages %}
          <article class="message-card {% if m.pinned %}pinned{% endif %}">
            <div class="message-meta">
              <div class="avatar small">
                {% if m.is_anonymous %}üë§{% else %}{{ m.avatar_emoji or "ü™©" }}{% endif %}
              </div>
              <div>
                <div class="message-author">
                  {% if m.is_anonymous %}Anonymous{% else %}{{ m.sender_name or "Unknown" }}{% endif %}
                </div>
                <div class="message-time">{{ m.ts }}</div>
              </div>
            </div>
            <div class="message-content">{{ m.body }}</div>
            {% if m.pinned %}<div class="pin-label">üìå Pinned</div>{% endif %}
          </article>
        {% else %}
          <div class="muted">No messages yet. Be the first to post.</div>
        {% endfor %}
      </div>
    </section>

    <section class="panel tab-panel {% if (tab or 'feed') == 'dm' %}active{% endif %}" data-tab="dm">
      <div class="panel-head">
        <div>
          <div class="panel-title">Direct Messages</div>
          <div class="panel-subtitle">Private between two characters</div>
        </div>
        <div class="pill live">LIVE</div>
      </div>
      {% if not character %}
        <p class="muted">Log in to DM someone.</p>
      {% else %}
        <div class="dm-shell" id="dm-shell">
          <div class="dm-list" id="dm-list">
            {% for thread in dm_threads %}
              <button
                class="dm-row-item {% if thread.unread_count %}unread{% endif %} {% if selected_dm == thread.other_id %}active{% endif %}"
                type="button"
                data-other-id="{{ thread.other_id }}"
                data-last-ts="{{ thread.last_ts or '' }}"
                data-unread="{{ thread.unread_count }}"
                data-name="{{ thread.name }}"
                data-role="{{ thread.role_tag }}"
                data-avatar="{{ thread.avatar_emoji }}"
              >
                <div class="avatar small">{{ thread.avatar_emoji }}</div>
                <div class="dm-row-main">
                  <div class="dm-row-top">
                    <div class="dm-row-name">{{ thread.name }}</div>
                    <div class="dm-row-time">{{ thread.last_ts or '' }}</div>
                  </div>
                  <div class="dm-row-preview">
                    {% if thread.last_body %}
                      {% if thread.last_sender_id == character.id %}You: {% endif %}{{ thread.last_body }}
                    {% else %}
                      <span class="dm-row-empty">No messages yet</span>
                    {% endif %}
                  </div>
                </div>
                <div class="dm-row-badge {% if not thread.unread_count %}hidden{% endif %}">{{ thread.unread_count }}</div>
              </button>
            {% endfor %}
          </div>

          <div class="dm-chat" id="dm-chat">
            <div class="dm-chat-head">
              <button class="btn ghost small dm-back" id="dm-back" type="button">Back</button>
              <div class="dm-chat-title">
                <div class="dm-chat-name" id="dm-chat-name">{{ selected_dm_name or "Select a DM" }}</div>
                <div class="dm-chat-role" id="dm-chat-role">{{ selected_dm_role or "" }}</div>
              </div>
              <div class="avatar small dm-chat-avatar" id="dm-chat-avatar" data-base-emoji="{{ selected_dm_avatar or 'ü™©' }}">{{ selected_dm_avatar or "ü™©" }}</div>
            </div>
            <div class="dm-thread" id="dm-thread">
              {% if selected_dm and (tab or 'feed') == 'dm' %}
                {% for m in thread_messages %}
                  <div class="dm-row {% if m.sender_id == character.id %}outgoing{% else %}incoming{% endif %}">
                    <div class="dm-message">
                      <div class="avatar tiny">{{ m.sender_avatar or "ü™©" }}</div>
                      <div class="dm-bubble">{{ m.body }}</div>
                    </div>
                  </div>
                {% else %}
                  <div class="muted">No DMs yet. Say hi.</div>
                {% endfor %}
              {% else %}
                <div class="muted">Pick a conversation to start.</div>
              {% endif %}
            </div>
            <form class="dm-form" action="{{ url_for('app_dm') }}" method="post">
              <input type="hidden" name="recipient_id" id="dm-recipient-input" value="{{ selected_dm or '' }}">
              <textarea name="body" rows="3" placeholder="Type a private message‚Ä¶" maxlength="280" required></textarea>
              <div class="actions">
                <button class="btn" type="button" onclick="document.querySelector('.dm-form textarea').value=''">Clear</button>
                <button class="btn primary" type="submit">Send DM</button>
              </div>
            </form>
          </div>
        </div>
      {% endif %}
    </section>

    <section class="panel tab-panel {% if (tab or 'feed') == 'suspect' %}active{% endif %} {% if not phase_two %}phase-locked{% endif %}" data-tab="suspect" id="suspect-panel">
      <div class="panel-head">
        <div>
          <div class="panel-title">Suspect Board</div>
          <div class="panel-subtitle">Accuse someone (+1 point)</div>
        </div>
        <div class="pill live">LIVE</div>
      </div>
      {% if not character %}
        <p class="muted">Log in to accuse suspects.</p>
      {% else %}
        <div class="cooldown-row {% if cooldown_remaining == 0 %}hidden{% endif %}" id="suspect-cooldown" data-seconds="{{ cooldown_remaining }}">
          Next accusation in <span id="suspect-timer">--:--</span>
        </div>
        <div class="suspect-grid app-suspect {% if cooldown_remaining > 0 %}cooldown{% endif %}">
          {% for c in characters %}
            {% if c.id != character.id %}
              <div class="suspect-card {% if not c.is_alive %}dead{% endif %}" data-char-id="{{ c.id }}" data-alive="{{ 1 if c.is_alive else 0 }}" data-score="{{ c.suspect_score }}">
                <div class="avatar small" data-emoji="{{ c.avatar_emoji }}">{{ c.avatar_emoji if c.is_alive else "üëª" }}</div>
                <div class="suspect-copy">
                  <div class="name">{{ c.name }}</div>
                  <div class="muted">{{ c.role_tag }}</div>
                </div>
                <div class="suspect-score" data-char-id="{{ c.id }}">{{ c.suspect_score }}</div>
                <div class="suspect-action">
                  <form class="suspect-action-form {% if not c.is_alive %}hidden{% endif %}" action="{{ url_for('app_accuse') }}" method="post">
                    <input type="hidden" name="accused_id" value="{{ c.id }}">
                    <button class="btn primary small" type="submit" {% if cooldown_remaining > 0 %}disabled{% endif %}>Accuse +1</button>
                  </form>
                  <div class="dead-pill {% if c.is_alive %}hidden{% endif %}">Murdered</div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </section>

    <section class="panel tab-panel {% if (tab or 'feed') == 'jukebox' %}active{% endif %}" data-tab="jukebox">
      <div class="panel-head">
        <div>
          <div class="panel-title">DJ Requests</div>
          <div class="panel-subtitle">Queue a track for the dance floor</div>
        </div>
      </div>
      {% if not character %}
        <p class="muted">Log in to queue songs.</p>
      {% endif %}
      {% if not songs %}
        <div class="muted">No songs found yet. Add audio files to <code>static/jukebox</code>.</div>
      {% else %}
        <div class="jukebox-list">
          {% for song in songs %}
            <div class="jukebox-row">
              <div class="jukebox-main">
                <div class="jukebox-title">{{ song.title }}</div>
                <div class="jukebox-artist">{{ song.artist }}</div>
              </div>
              <form action="{{ url_for('app_jukebox_queue') }}" method="post">
                <input type="hidden" name="song_filename" value="{{ song.filename }}">
                {% if song.queued %}
                  <button class="btn small queued" type="button" disabled>Queued</button>
                {% else %}
                  <button class="btn small" type="submit" {% if not character %}disabled{% endif %}>Queue</button>
                {% endif %}
              </form>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </section>

    <section class="panel tab-panel {% if (tab or 'feed') == 'wallet' %}active{% endif %}" data-tab="wallet">
      <div class="panel-head">
        <div>
          <div class="panel-title">Wallet</div>
          <div class="panel-subtitle">Send or request cash from other players</div>
        </div>
      </div>
      {% if not character %}
        <p class="muted">Log in to manage your wallet.</p>
      {% else %}
        <div class="wallet-balance">
          <div>
            <div class="muted">Current Balance</div>
            <div class="wallet-amount">${{ character.balance }}</div>
          </div>
          <div class="wallet-note">Transfers always require a double confirmation.</div>
        </div>

        {% if wallet_pending or wallet_notifications %}
          <div class="wallet-requests">
            <div class="panel-title">Notifications</div>
            {% for note in wallet_notifications %}
              <div class="wallet-request-row">
                <div class="avatar small">{{ note.sender_avatar }}</div>
                <div class="wallet-request-main">
                  <div class="wallet-request-name">{{ note.sender_name }}</div>
                  <div class="muted">sent you ${{ note.amount }}</div>
                </div>
                <form class="wallet-action" action="{{ url_for('app_wallet_notification_dismiss') }}" method="post">
                  <input type="hidden" name="notification_id" value="{{ note.id }}">
                  <button class="btn ghost small" type="submit">Dismiss</button>
                </form>
              </div>
            {% endfor %}
            {% for req in wallet_pending %}
              <div class="wallet-request-row">
                <div class="avatar small">{{ req.requester_avatar }}</div>
                <div class="wallet-request-main">
                  <div class="wallet-request-name">{{ req.requester_name }}</div>
                  <div class="muted">is requesting ${{ req.amount }}</div>
                </div>
                <form class="wallet-action" action="{{ url_for('app_wallet_request_respond') }}" method="post" data-double-confirm data-confirm-mode="accept-send" data-requester="{{ req.requester_name }}" data-amount="{{ req.amount }}">
                  <input type="hidden" name="request_id" value="{{ req.id }}">
                  <input type="hidden" name="decision" value="accept">
                  <button class="btn primary small" type="submit">Send</button>
                </form>
                <form class="wallet-action" action="{{ url_for('app_wallet_request_respond') }}" method="post">
                  <input type="hidden" name="request_id" value="{{ req.id }}">
                  <input type="hidden" name="decision" value="decline">
                  <button class="btn ghost small" type="submit">Decline</button>
                </form>
              </div>
            {% endfor %}
          </div>
          <hr class="divider" />
        {% endif %}

        <div class="wallet-card">
          <div class="panel-title">Transfer Money</div>
          <form class="wallet-form" id="wallet-transfer-form" method="post" data-double-confirm data-send-action="{{ url_for('app_wallet_send') }}" data-request-action="{{ url_for('app_wallet_request') }}">
            <label class="form-label" for="wallet-transfer-type">Type</label>
            <select id="wallet-transfer-type" name="transfer_type" required>
              <option value="send" selected>Send</option>
              <option value="request">Request</option>
            </select>
            <label class="form-label" for="wallet-transfer-target">Player</label>
            <select id="wallet-transfer-target" name="target_id" required>
              <option value="" disabled selected>Select a player</option>
              {% for c in characters %}
                {% if c.id != character.id %}
                  <option value="{{ c.id }}">{{ c.name }} ‚Äî {{ c.role_tag }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <label class="form-label" for="wallet-transfer-amount">Amount</label>
            <input id="wallet-transfer-amount" type="number" name="amount" min="1" step="1" placeholder="50" required />
            <div class="actions">
              <button class="btn" type="reset">Clear</button>
              <button class="btn primary" type="submit" id="wallet-transfer-submit">Send</button>
            </div>
          </form>
        </div>
      {% endif %}
    </section>
  </main>

  <script>
    const appShell = document.querySelector(".app-shell");
    const tabButtons = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".tab-panel");
    let isPhaseTwo = {{ "true" if phase_two else "false" }};
    let activeTab = appShell?.dataset.activeTab || "feed";
    const meId = {{ character.id if character else "null" }};
    let currentDm = {{ selected_dm if selected_dm else "null" }};
    const feedEl = document.getElementById("app-feed");
    const feedApi = "{{ url_for('api_messages') }}";
    const dmRecipientInput = document.getElementById("dm-recipient-input");
    const dmThreadEl = document.getElementById("dm-thread");
    const dmBadge = document.getElementById("dm-badge");
    const dmListEl = document.getElementById("dm-list");
    const dmShell = document.getElementById("dm-shell");
    const dmBack = document.getElementById("dm-back");
    const dmChatName = document.getElementById("dm-chat-name");
    const dmChatRole = document.getElementById("dm-chat-role");
    const dmChatAvatar = document.getElementById("dm-chat-avatar");
    let totalUnread = parseInt(dmBadge?.dataset.count || "0", 10);
    const suspectCooldownEl = document.getElementById("suspect-cooldown");
    const suspectTimerEl = document.getElementById("suspect-timer");
    const suspectClockEl = document.getElementById("suspect-clock");
    const suspectPanel = document.getElementById("suspect-panel");
    const suspectButtons = suspectPanel ? suspectPanel.querySelectorAll("button[type='submit']") : [];
    const suspectGrid = suspectPanel ? suspectPanel.querySelector(".suspect-grid") : null;
    let suspectRemaining = parseInt(suspectCooldownEl?.dataset.seconds || "0", 10);

    function isTabAvailable(tab) {
      if (!tab) return false;
      if (tab === "suspect" && !isPhaseTwo) return false;
      const btn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
      if (!btn) return false;
      if (btn.classList.contains("hidden-tab")) return false;
      return !btn.disabled;
    }

    if (activeTab !== "feed" && !isTabAvailable(activeTab)) {
      activeTab = "feed";
    }

    if (!currentDm && dmListEl) {
      const firstRow = dmListEl.querySelector(".dm-row-item");
      if (firstRow) {
        currentDm = parseInt(firstRow.dataset.otherId, 10) || null;
      }
    }
    if (dmRecipientInput) dmRecipientInput.value = currentDm || "";

    function setTab(tab) {
      if (!isTabAvailable(tab)) {
        tab = "feed";
      }
      activeTab = tab;
      tabButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      panels.forEach(panel => {
        panel.classList.toggle("active", panel.dataset.tab === tab);
      });
      if (tab !== "dm" && dmShell) {
        dmShell.classList.remove("chat-active");
      }
      if (tab === "dm" && currentDm && dmListEl) {
        selectDmThread(currentDm, true);
      }
    }
    function syncPhaseUi() {
      document.body.classList.toggle("phase-two", isPhaseTwo);
      document.body.classList.toggle("phase-one", !isPhaseTwo);
      const suspectBtn = document.querySelector(".tab-btn[data-tab='suspect']");
      const suspectPanelEl = document.querySelector(".tab-panel[data-tab='suspect']");
      if (suspectBtn) {
        suspectBtn.classList.toggle("hidden-tab", !isPhaseTwo);
      }
      if (suspectPanelEl) {
        suspectPanelEl.classList.toggle("phase-locked", !isPhaseTwo);
      }
      if (!isPhaseTwo && activeTab === "suspect") {
        setTab("feed");
      } else if (isPhaseTwo && suspectRemaining <= 0) {
        setSuspectEnabled(true);
      }
    }
    syncPhaseUi();
    setTab(activeTab);
    reflowSuspects();
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.disabled || btn.classList.contains("hidden-tab")) return;
        setTab(btn.dataset.tab);
      });
    });

    function renderFeed(data) {
      if (!feedEl) return;
      feedEl.innerHTML = "";
      if (!data.length) {
        feedEl.innerHTML = "<div class='muted'>No messages yet.</div>";
        return;
      }
      data.sort((a, b) => {
        if (a.pinned === b.pinned) return 0;
        return a.pinned ? -1 : 1;
      });
      data.forEach(msg => addFeedMessage(msg, false));
    }

    function addFeedMessage(msg, prepend = true) {
      if (!feedEl) return;
      const item = document.createElement("article");
      item.className = "message-card" + (msg.pinned ? " pinned" : "");
      item.innerHTML = `
        <div class="message-meta">
          <div class="avatar small">${msg.is_anonymous ? "üë§" : (msg.avatar || "ü™©")}</div>
          <div>
            <div class="message-author">${msg.is_anonymous ? "Anonymous" : msg.author}</div>
            <div class="message-time">${msg.ts}</div>
          </div>
        </div>
        <div class="message-content"></div>
        ${msg.pinned ? '<div class="pin-label">üìå Pinned</div>' : ''}
      `;
      item.querySelector(".message-content").textContent = msg.body;
      if (msg.pinned) {
        feedEl.prepend(item);
      } else if (prepend) {
        const pinnedEl = feedEl.querySelector(".message-card.pinned");
        if (pinnedEl && pinnedEl.nextSibling) {
          pinnedEl.parentNode.insertBefore(item, pinnedEl.nextSibling);
        } else {
          feedEl.prepend(item);
        }
      } else {
        feedEl.appendChild(item);
      }
      while (feedEl.children.length > 50) {
        feedEl.removeChild(feedEl.lastChild);
      }
    }

    async function refreshFeed() {
      try {
        const res = await fetch(feedApi);
        if (!res.ok) return;
        const data = await res.json();
        renderFeed(data);
      } catch (err) {
        console.error(err);
      }
    }

    function renderThread(messages) {
      if (!dmThreadEl) return;
      dmThreadEl.innerHTML = "";
      if (!messages.length) {
        dmThreadEl.innerHTML = "<div class='muted'>No DMs yet. Say hi.</div>";
        return;
      }
      messages.forEach(m => appendDmMessage(m));
      dmThreadEl.scrollTop = dmThreadEl.scrollHeight;
    }

    function appendDmMessage(msg) {
      if (!dmThreadEl) return;
      const row = document.createElement("div");
      row.className = "dm-row " + (msg.sender_id === meId ? "outgoing" : "incoming");
      row.innerHTML = `
        <div class="dm-message">
          <div class="avatar tiny">${msg.sender_avatar || "ü™©"}</div>
          <div class="dm-bubble"></div>
        </div>
      `;
      row.querySelector(".dm-bubble").textContent = msg.body;
      dmThreadEl.appendChild(row);
    }

    async function loadThread(recipientId) {
      if (!recipientId || !meId) return;
      try {
        const res = await fetch(`/api/thread/${recipientId}`);
        if (!res.ok) return;
        const data = await res.json();
        renderThread(data);
      } catch (err) {
        console.error(err);
      }
    }

    async function markThreadRead(recipientId) {
      if (!recipientId || !meId) return;
      try {
        await fetch(`/api/thread/${recipientId}/read`, { method: "POST" });
      } catch (err) {
        console.error(err);
      }
    }

    function updateBadge(count) {
      if (!dmBadge) return;
      dmBadge.dataset.count = count;
      dmBadge.textContent = count;
      dmBadge.classList.toggle("hidden", count <= 0);
    }

    function recalcUnread() {
      if (!dmListEl) return;
      const total = Array.from(dmListEl.querySelectorAll(".dm-row-item"))
        .reduce((sum, row) => sum + parseInt(row.dataset.unread || "0", 10), 0);
      totalUnread = total;
      updateBadge(totalUnread);
    }

    function sortDmList() {
      if (!dmListEl) return;
      const rows = Array.from(dmListEl.querySelectorAll(".dm-row-item"));
      rows.sort((a, b) => {
        const aTs = a.dataset.lastTs || "";
        const bTs = b.dataset.lastTs || "";
        if (aTs === bTs) return 0;
        return aTs < bTs ? 1 : -1;
      });
      rows.forEach(row => dmListEl.appendChild(row));
    }

    function setChatHeader(row) {
      if (!row) return;
      if (dmChatName) dmChatName.textContent = row.dataset.name || "Direct Message";
      if (dmChatRole) dmChatRole.textContent = row.dataset.role || "";
      if (dmChatAvatar) dmChatAvatar.textContent = row.dataset.avatar || "ü™©";
    }

    function selectDmThread(otherId, openChat = false) {
      if (!dmListEl) return;
      const row = dmListEl.querySelector(`[data-other-id="${otherId}"]`);
      if (!row) return;
      currentDm = otherId;
      if (dmRecipientInput) dmRecipientInput.value = currentDm || "";
      dmListEl.querySelectorAll(".dm-row-item").forEach(item => {
        item.classList.toggle("active", item === row);
      });
      setChatHeader(row);
      if (openChat && dmShell) dmShell.classList.add("chat-active");

      const unreadCount = parseInt(row.dataset.unread || "0", 10);
      if (unreadCount > 0) {
        row.dataset.unread = "0";
        row.classList.remove("unread");
        const badge = row.querySelector(".dm-row-badge");
        if (badge) {
          badge.textContent = "0";
          badge.classList.add("hidden");
        }
        recalcUnread();
      }
      loadThread(currentDm);
    }

    function formatTime(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.max(0, totalSeconds % 60);
      return `${minutes}:${seconds.toString().padStart(2, "0")}`;
    }

    function setSuspectEnabled(enabled) {
      if (!suspectButtons) return;
      suspectButtons.forEach(btn => {
        btn.disabled = !enabled;
      });
      if (suspectGrid) {
        suspectGrid.classList.toggle("cooldown", !enabled);
      }
      if (suspectClockEl) {
        suspectClockEl.classList.toggle("hidden", enabled);
      }
      if (suspectCooldownEl) {
        suspectCooldownEl.classList.toggle("hidden", enabled);
      }
    }

    function tickSuspectCooldown() {
      if (!suspectCooldownEl || !suspectTimerEl) return;
      if (suspectRemaining <= 0) {
        setSuspectEnabled(true);
        return;
      }
      setSuspectEnabled(false);
      suspectTimerEl.textContent = formatTime(suspectRemaining);
      suspectRemaining -= 1;
    }

    function reflowSuspects() {
      if (!suspectGrid) return;
      const cards = Array.from(suspectGrid.querySelectorAll(".suspect-card"));
      cards.sort((a, b) => {
        const aliveA = parseInt(a.dataset.alive || "1", 10);
        const aliveB = parseInt(b.dataset.alive || "1", 10);
        if (aliveA !== aliveB) return aliveB - aliveA;
        const scoreA = parseInt(a.dataset.score || "0", 10);
        const scoreB = parseInt(b.dataset.score || "0", 10);
        if (scoreA !== scoreB) return scoreB - scoreA;
        const nameA = (a.querySelector(".name")?.textContent || "").toLowerCase();
        const nameB = (b.querySelector(".name")?.textContent || "").toLowerCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
      });
      cards.forEach(card => suspectGrid.appendChild(card));
    }

    function updateSuspectStatus(data) {
      if (!suspectGrid) return;
      const card = suspectGrid.querySelector(`.suspect-card[data-char-id="${data.character_id}"]`);
      if (!card) return;
      const alive = !!data.is_alive;
      card.dataset.alive = alive ? "1" : "0";
      card.classList.toggle("dead", !alive);
      const avatar = card.querySelector(".avatar");
      if (avatar) {
        const baseEmoji = avatar.dataset.emoji || avatar.textContent || "ü™©";
        avatar.textContent = alive ? baseEmoji : "üëª";
      }
      if (typeof data.suspect_score === "number") {
        const scoreEl = card.querySelector(".suspect-score");
        if (scoreEl) scoreEl.textContent = data.suspect_score;
        card.dataset.score = data.suspect_score;
      }
      const form = card.querySelector(".suspect-action-form");
      const btn = form ? form.querySelector("button[type='submit']") : null;
      const deadPill = card.querySelector(".dead-pill");
      if (form) form.classList.toggle("hidden", !alive);
      if (btn) btn.disabled = !alive || suspectRemaining > 0;
      if (deadPill) deadPill.classList.toggle("hidden", alive);
      reflowSuspects();
      if (dmListEl) {
        const dmRow = dmListEl.querySelector(`.dm-row-item[data-other-id="${data.character_id}"]`);
        if (dmRow) {
          const avatarEl = dmRow.querySelector(".avatar.small");
          if (avatarEl) {
            const base = dmRow.dataset.avatar || avatarEl.textContent || "ü™©";
            avatarEl.textContent = alive ? base : "üëª";
          }
        }
      }
      if (currentDm === data.character_id && dmChatAvatar) {
        const baseChat = dmChatAvatar.dataset.baseEmoji || dmChatAvatar.textContent || "ü™©";
        dmChatAvatar.textContent = alive ? baseChat : "üëª";
      }
    }

    function updateDmRowFromMessage(msg, incrementUnread) {
      if (!dmListEl) return;
      const otherId = msg.sender_id === meId ? msg.recipient_id : msg.sender_id;
      const row = dmListEl.querySelector(`[data-other-id="${otherId}"]`);
      if (!row) return;
      row.dataset.lastTs = msg.ts || "";
      const timeEl = row.querySelector(".dm-row-time");
      const previewEl = row.querySelector(".dm-row-preview");
      if (timeEl) timeEl.textContent = msg.ts || "";
      if (previewEl) {
        const prefix = msg.sender_id === meId ? "You: " : "";
        previewEl.textContent = `${prefix}${msg.body}`;
      }
      if (incrementUnread) {
        const unread = parseInt(row.dataset.unread || "0", 10) + 1;
        row.dataset.unread = unread;
        row.classList.add("unread");
        const badge = row.querySelector(".dm-row-badge");
        if (badge) {
          badge.textContent = unread;
          badge.classList.remove("hidden");
        }
        recalcUnread();
      }
      sortDmList();
    }

    if (dmListEl) {
      dmListEl.addEventListener("click", (event) => {
        const row = event.target.closest(".dm-row-item");
        if (!row) return;
        selectDmThread(parseInt(row.dataset.otherId, 10), true);
      });
    }

    if (dmBack && dmShell) {
      dmBack.addEventListener("click", () => {
        dmShell.classList.remove("chat-active");
      });
    }

    function buildTransferMessage(form) {
      const mode = form.dataset.confirmMode || "";
      if (mode === "send") {
        const amount = form.querySelector("input[name='amount']")?.value;
        const target = form.querySelector("select[name='target_id']")?.selectedOptions?.[0]?.textContent || "that player";
        return `Send $${amount || "0"} to ${target}?`;
      }
      if (mode === "request") {
        const amount = form.querySelector("input[name='amount']")?.value;
        const target = form.querySelector("select[name='target_id']")?.selectedOptions?.[0]?.textContent || "that player";
        return `Request $${amount || "0"} from ${target}?`;
      }
      if (mode === "accept-send") {
        const amount = form.dataset.amount || "0";
        const requester = form.dataset.requester || "that player";
        return `Send $${amount} to ${requester}?`;
      }
      return "Confirm this transfer?";
    }

    function attachDoubleConfirm() {
      const forms = document.querySelectorAll("form[data-double-confirm]");
      forms.forEach(form => {
        form.addEventListener("submit", (event) => {
          const first = buildTransferMessage(form);
          const second = `Final check: ${first}`;
          if (!confirm(first)) {
            event.preventDefault();
            return;
          }
          if (!confirm(second)) {
            event.preventDefault();
          }
        });
      });
    }

    const walletTransferForm = document.getElementById("wallet-transfer-form");
    const walletTransferType = document.getElementById("wallet-transfer-type");
    const walletTransferSubmit = document.getElementById("wallet-transfer-submit");

    function syncWalletTransferForm() {
      if (!walletTransferForm || !walletTransferType) return;
      const isRequest = walletTransferType.value === "request";
      walletTransferForm.action = isRequest ? walletTransferForm.dataset.requestAction : walletTransferForm.dataset.sendAction;
      walletTransferForm.dataset.confirmMode = isRequest ? "request" : "send";
      if (walletTransferSubmit) {
        walletTransferSubmit.textContent = isRequest ? "Request" : "Send";
      }
    }

    if (walletTransferType) {
      walletTransferType.addEventListener("change", syncWalletTransferForm);
    }
    syncWalletTransferForm();
    attachDoubleConfirm();

    const socket = io();
    socket.on("connect", () => {
      if (meId) {
        socket.emit("join", { character_id: meId });
      }
    });
    socket.on("public_message", (msg) => addFeedMessage(msg));
    socket.on("public_cleared", () => refreshFeed());
    socket.on("dm", (msg) => {
      if (!meId) return;
      if (msg.sender_id !== meId && msg.recipient_id !== meId) return;
      const otherId = msg.sender_id === meId ? msg.recipient_id : msg.sender_id;
      const isIncoming = msg.sender_id !== meId;
      const isActiveThread = activeTab === "dm" && currentDm === otherId && dmShell?.classList.contains("chat-active");

      updateDmRowFromMessage(msg, isIncoming && !isActiveThread);

      if (currentDm && otherId === currentDm) {
        if (dmThreadEl && dmThreadEl.innerHTML.includes("Pick a conversation")) {
          dmThreadEl.innerHTML = "";
        }
        if (dmThreadEl && dmThreadEl.innerHTML.includes("No DMs yet")) {
          dmThreadEl.innerHTML = "";
        }
        appendDmMessage(msg);
        dmThreadEl.scrollTop = dmThreadEl.scrollHeight;
        if (isIncoming && isActiveThread) {
          markThreadRead(otherId);
        }
      }
    });
    socket.on("suspect_update", (data) => {
      const els = document.querySelectorAll(`[data-char-id="${data.character_id}"]`);
      els.forEach(el => el.textContent = data.suspect_score);
      const card = suspectGrid ? suspectGrid.querySelector(`.suspect-card[data-char-id="${data.character_id}"]`) : null;
      if (card) {
        card.dataset.score = data.suspect_score;
        reflowSuspects();
      }
    });
    socket.on("character_status", (data) => {
      updateSuspectStatus(data);
    });
    socket.on("phase_change", (data) => {
      isPhaseTwo = !!(data && data.phase_two);
      syncPhaseUi();
      reflowSuspects();
    });

    if (suspectRemaining > 0) {
      tickSuspectCooldown();
      setInterval(tickSuspectCooldown, 1000);
    } else if (suspectButtons.length) {
      setSuspectEnabled(true);
    }

    refreshFeed();
    setInterval(refreshFeed, 15000);
  </script>
</body>
</html>
